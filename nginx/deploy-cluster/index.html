<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Nginx - 部署与集群 | Gavin blog</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_3114978_qe0b39no76.css">
    <noscript><meta http-equiv="refresh" content="0; url=https://www.Gavin.cn/noscript/"><style>.theme-vdoing-content { display:none }</noscript>
    <script src="https://fastly.jsdelivr.net/npm/twikoo@1.4.18/dist/twikoo.all.min.js"></script>
    <script>var _hmt = _hmt || [];
          (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?2d1a0bb0086e59e97dfd52598481b49b"; 
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
          })();
          </script>
    <meta name="description" content="Gavin个人博客, VuePress搭建, 使用了 Vdoing 主题, 学习Java, Web, 框架, 微服务, 工具, 前端等相关知识, 记录生活和技术路程, 同时分享编程技巧。">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <meta name="baidu-site-verification" content="code-fLaULewlcT">
    <meta name="keywords" content="Gavin个人博客, VuePress搭建, 学习Java、Web、框架、微服务、工具、前端等相关知识, 记录生活和技术路程。">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.37875d28.css" as="style"><link rel="preload" href="/assets/js/app.0c74b603.js" as="script"><link rel="preload" href="/assets/js/2.05f7d542.js" as="script"><link rel="preload" href="/assets/js/213.b44014c3.js" as="script"><link rel="preload" href="/assets/js/15.8dd074d9.js" as="script"><link rel="preload" href="/assets/js/5.a78e8ca1.js" as="script"><link rel="preload" href="/assets/js/16.e2aaf81b.js" as="script"><link rel="preload" href="/assets/js/12.aaee4f64.js" as="script"><link rel="prefetch" href="/assets/js/10.0d1b4b1d.js"><link rel="prefetch" href="/assets/js/100.6b2c7ae4.js"><link rel="prefetch" href="/assets/js/101.3467c168.js"><link rel="prefetch" href="/assets/js/102.a0bb26ed.js"><link rel="prefetch" href="/assets/js/103.fcf4fd24.js"><link rel="prefetch" href="/assets/js/104.86c00fb0.js"><link rel="prefetch" href="/assets/js/105.9b7893da.js"><link rel="prefetch" href="/assets/js/106.8e898a5c.js"><link rel="prefetch" href="/assets/js/107.101c6a81.js"><link rel="prefetch" href="/assets/js/108.35a3ab23.js"><link rel="prefetch" href="/assets/js/109.435cbe8b.js"><link rel="prefetch" href="/assets/js/11.ef419a56.js"><link rel="prefetch" href="/assets/js/110.cd81226e.js"><link rel="prefetch" href="/assets/js/111.f126c1f5.js"><link rel="prefetch" href="/assets/js/112.2c4ef2fc.js"><link rel="prefetch" href="/assets/js/113.9e773ca3.js"><link rel="prefetch" href="/assets/js/114.5e0b97ea.js"><link rel="prefetch" href="/assets/js/115.1d3c3533.js"><link rel="prefetch" href="/assets/js/116.196deaa0.js"><link rel="prefetch" href="/assets/js/117.2573ef4d.js"><link rel="prefetch" href="/assets/js/118.3384ea9a.js"><link rel="prefetch" href="/assets/js/119.072ee103.js"><link rel="prefetch" href="/assets/js/120.367e1a88.js"><link rel="prefetch" href="/assets/js/121.bef1f2ad.js"><link rel="prefetch" href="/assets/js/122.e620cb9e.js"><link rel="prefetch" href="/assets/js/123.8cb32076.js"><link rel="prefetch" href="/assets/js/124.463a7ee8.js"><link rel="prefetch" href="/assets/js/125.7fedcfd3.js"><link rel="prefetch" href="/assets/js/126.0a17b198.js"><link rel="prefetch" href="/assets/js/127.16bf383f.js"><link rel="prefetch" href="/assets/js/128.98a53d27.js"><link rel="prefetch" href="/assets/js/129.2316cfcb.js"><link rel="prefetch" href="/assets/js/13.b41f3bda.js"><link rel="prefetch" href="/assets/js/130.76d0b2e1.js"><link rel="prefetch" href="/assets/js/131.29507387.js"><link rel="prefetch" href="/assets/js/132.666f37d4.js"><link rel="prefetch" href="/assets/js/133.92b3905d.js"><link rel="prefetch" href="/assets/js/134.1d3316a8.js"><link rel="prefetch" href="/assets/js/135.5c289694.js"><link rel="prefetch" href="/assets/js/136.4075a5b9.js"><link rel="prefetch" href="/assets/js/137.6cb0a107.js"><link rel="prefetch" href="/assets/js/138.fcebecb8.js"><link rel="prefetch" href="/assets/js/139.f17dfd55.js"><link rel="prefetch" href="/assets/js/14.4f656161.js"><link rel="prefetch" href="/assets/js/140.6ccb5886.js"><link rel="prefetch" href="/assets/js/141.595b1f67.js"><link rel="prefetch" href="/assets/js/142.d5226950.js"><link rel="prefetch" href="/assets/js/143.03ec2dd1.js"><link rel="prefetch" href="/assets/js/144.fb1421a4.js"><link rel="prefetch" href="/assets/js/145.09cb6b07.js"><link rel="prefetch" href="/assets/js/146.a0e1a8fe.js"><link rel="prefetch" href="/assets/js/147.eb06b181.js"><link rel="prefetch" href="/assets/js/148.01919744.js"><link rel="prefetch" href="/assets/js/149.f0f798ec.js"><link rel="prefetch" href="/assets/js/150.0349c22d.js"><link rel="prefetch" href="/assets/js/151.7a4f33c4.js"><link rel="prefetch" href="/assets/js/152.c173c3be.js"><link rel="prefetch" href="/assets/js/153.b0f3dc90.js"><link rel="prefetch" href="/assets/js/154.5214c347.js"><link rel="prefetch" href="/assets/js/155.e6faaf96.js"><link rel="prefetch" href="/assets/js/156.a6650de7.js"><link rel="prefetch" href="/assets/js/157.10f66edb.js"><link rel="prefetch" href="/assets/js/158.86c0c071.js"><link rel="prefetch" href="/assets/js/159.d6d28fd2.js"><link rel="prefetch" href="/assets/js/160.a4e550fd.js"><link rel="prefetch" href="/assets/js/161.9198d9c5.js"><link rel="prefetch" href="/assets/js/162.aa9920c9.js"><link rel="prefetch" href="/assets/js/163.fd0fb5c1.js"><link rel="prefetch" href="/assets/js/164.24dec11e.js"><link rel="prefetch" href="/assets/js/165.d76e0e43.js"><link rel="prefetch" href="/assets/js/166.5cbac865.js"><link rel="prefetch" href="/assets/js/167.84a9539b.js"><link rel="prefetch" href="/assets/js/168.02a7921c.js"><link rel="prefetch" href="/assets/js/169.1540a348.js"><link rel="prefetch" href="/assets/js/17.82137d1c.js"><link rel="prefetch" href="/assets/js/170.ca62803e.js"><link rel="prefetch" href="/assets/js/171.cbc52b23.js"><link rel="prefetch" href="/assets/js/172.c860f6ec.js"><link rel="prefetch" href="/assets/js/173.4d04507d.js"><link rel="prefetch" href="/assets/js/174.697f64e7.js"><link rel="prefetch" href="/assets/js/175.89bef03d.js"><link rel="prefetch" href="/assets/js/176.97fc1f9c.js"><link rel="prefetch" href="/assets/js/177.14490c31.js"><link rel="prefetch" href="/assets/js/178.0b253bb0.js"><link rel="prefetch" href="/assets/js/179.5ce4b923.js"><link rel="prefetch" href="/assets/js/18.00a85868.js"><link rel="prefetch" href="/assets/js/180.b630efe1.js"><link rel="prefetch" href="/assets/js/181.37350499.js"><link rel="prefetch" href="/assets/js/182.05201774.js"><link rel="prefetch" href="/assets/js/183.b19ed5d3.js"><link rel="prefetch" href="/assets/js/184.46e697da.js"><link rel="prefetch" href="/assets/js/185.a07ffd0b.js"><link rel="prefetch" href="/assets/js/186.1406f389.js"><link rel="prefetch" href="/assets/js/187.5104dc44.js"><link rel="prefetch" href="/assets/js/188.5e1cb737.js"><link rel="prefetch" href="/assets/js/189.bf6e4fe2.js"><link rel="prefetch" href="/assets/js/19.115f3264.js"><link rel="prefetch" href="/assets/js/190.a5fbdb5e.js"><link rel="prefetch" href="/assets/js/191.38ff4946.js"><link rel="prefetch" href="/assets/js/192.9cba6339.js"><link rel="prefetch" href="/assets/js/193.64734b87.js"><link rel="prefetch" href="/assets/js/194.7779c85f.js"><link rel="prefetch" href="/assets/js/195.91a09d33.js"><link rel="prefetch" href="/assets/js/196.9181523d.js"><link rel="prefetch" href="/assets/js/197.f279f066.js"><link rel="prefetch" href="/assets/js/198.ac7151d3.js"><link rel="prefetch" href="/assets/js/199.a29c5c92.js"><link rel="prefetch" href="/assets/js/20.4e9528a2.js"><link rel="prefetch" href="/assets/js/200.750b6919.js"><link rel="prefetch" href="/assets/js/201.13508ead.js"><link rel="prefetch" href="/assets/js/202.7cb3b306.js"><link rel="prefetch" href="/assets/js/203.6aee9931.js"><link rel="prefetch" href="/assets/js/204.690985bb.js"><link rel="prefetch" href="/assets/js/205.86259663.js"><link rel="prefetch" href="/assets/js/206.9296d977.js"><link rel="prefetch" href="/assets/js/207.45f98d88.js"><link rel="prefetch" href="/assets/js/208.7153c290.js"><link rel="prefetch" href="/assets/js/209.9275a844.js"><link rel="prefetch" href="/assets/js/21.d1bb9862.js"><link rel="prefetch" href="/assets/js/210.bda617a1.js"><link rel="prefetch" href="/assets/js/211.f29bc51e.js"><link rel="prefetch" href="/assets/js/212.8ca7dc67.js"><link rel="prefetch" href="/assets/js/214.12888a50.js"><link rel="prefetch" href="/assets/js/215.b68f5f7a.js"><link rel="prefetch" href="/assets/js/216.29e5cd44.js"><link rel="prefetch" href="/assets/js/217.62d88c59.js"><link rel="prefetch" href="/assets/js/218.2135ea2c.js"><link rel="prefetch" href="/assets/js/219.aa749f8b.js"><link rel="prefetch" href="/assets/js/22.26e69947.js"><link rel="prefetch" href="/assets/js/220.413be21d.js"><link rel="prefetch" href="/assets/js/221.36bcd25f.js"><link rel="prefetch" href="/assets/js/222.024e3d93.js"><link rel="prefetch" href="/assets/js/223.bef9b0d5.js"><link rel="prefetch" href="/assets/js/224.b964c123.js"><link rel="prefetch" href="/assets/js/225.6382732e.js"><link rel="prefetch" href="/assets/js/226.c536b7b7.js"><link rel="prefetch" href="/assets/js/227.3574d1eb.js"><link rel="prefetch" href="/assets/js/228.0030d01e.js"><link rel="prefetch" href="/assets/js/229.8fbc939f.js"><link rel="prefetch" href="/assets/js/23.7390f241.js"><link rel="prefetch" href="/assets/js/230.465d136d.js"><link rel="prefetch" href="/assets/js/231.2b96eb77.js"><link rel="prefetch" href="/assets/js/232.f8f79e42.js"><link rel="prefetch" href="/assets/js/233.1a682126.js"><link rel="prefetch" href="/assets/js/234.e48008a7.js"><link rel="prefetch" href="/assets/js/235.65bb688b.js"><link rel="prefetch" href="/assets/js/236.5826c7ea.js"><link rel="prefetch" href="/assets/js/237.efa06d47.js"><link rel="prefetch" href="/assets/js/238.b82dd942.js"><link rel="prefetch" href="/assets/js/239.60043f3f.js"><link rel="prefetch" href="/assets/js/24.da624ec9.js"><link rel="prefetch" href="/assets/js/240.4db184c5.js"><link rel="prefetch" href="/assets/js/241.d180336b.js"><link rel="prefetch" href="/assets/js/242.6f9f883f.js"><link rel="prefetch" href="/assets/js/243.9c02b47d.js"><link rel="prefetch" href="/assets/js/244.55c39f98.js"><link rel="prefetch" href="/assets/js/245.b65a66b8.js"><link rel="prefetch" href="/assets/js/246.cf37b7ab.js"><link rel="prefetch" href="/assets/js/247.d67411ea.js"><link rel="prefetch" href="/assets/js/248.549a961e.js"><link rel="prefetch" href="/assets/js/249.9f24347f.js"><link rel="prefetch" href="/assets/js/25.91845d8b.js"><link rel="prefetch" href="/assets/js/250.42b9cfc6.js"><link rel="prefetch" href="/assets/js/251.edc0716d.js"><link rel="prefetch" href="/assets/js/252.dd9a197b.js"><link rel="prefetch" href="/assets/js/253.71ac56e8.js"><link rel="prefetch" href="/assets/js/254.5150d1da.js"><link rel="prefetch" href="/assets/js/255.76b6dd7b.js"><link rel="prefetch" href="/assets/js/256.111dc383.js"><link rel="prefetch" href="/assets/js/257.ca2e08f1.js"><link rel="prefetch" href="/assets/js/258.a86640b2.js"><link rel="prefetch" href="/assets/js/259.137bacf8.js"><link rel="prefetch" href="/assets/js/26.6fd8717c.js"><link rel="prefetch" href="/assets/js/260.e6d27b01.js"><link rel="prefetch" href="/assets/js/261.8bec383d.js"><link rel="prefetch" href="/assets/js/262.cca6c374.js"><link rel="prefetch" href="/assets/js/263.799897a4.js"><link rel="prefetch" href="/assets/js/264.020a86d9.js"><link rel="prefetch" href="/assets/js/265.b99d96d4.js"><link rel="prefetch" href="/assets/js/266.c8fb8325.js"><link rel="prefetch" href="/assets/js/267.68b01f56.js"><link rel="prefetch" href="/assets/js/268.37cd2646.js"><link rel="prefetch" href="/assets/js/269.9957c67e.js"><link rel="prefetch" href="/assets/js/27.fdf1f82f.js"><link rel="prefetch" href="/assets/js/270.509c0feb.js"><link rel="prefetch" href="/assets/js/271.7602a2ce.js"><link rel="prefetch" href="/assets/js/272.7620aba7.js"><link rel="prefetch" href="/assets/js/273.48c91db5.js"><link rel="prefetch" href="/assets/js/274.5d5616a4.js"><link rel="prefetch" href="/assets/js/275.a7178b9a.js"><link rel="prefetch" href="/assets/js/276.8be99ca2.js"><link rel="prefetch" href="/assets/js/277.62ee1f96.js"><link rel="prefetch" href="/assets/js/278.c5f11afe.js"><link rel="prefetch" href="/assets/js/279.70c2c667.js"><link rel="prefetch" href="/assets/js/28.cfd8d122.js"><link rel="prefetch" href="/assets/js/280.26f44f2d.js"><link rel="prefetch" href="/assets/js/281.a1eedd7c.js"><link rel="prefetch" href="/assets/js/282.9cc07e9a.js"><link rel="prefetch" href="/assets/js/283.41b7f1f9.js"><link rel="prefetch" href="/assets/js/284.8d9df114.js"><link rel="prefetch" href="/assets/js/285.9bc23b08.js"><link rel="prefetch" href="/assets/js/286.1781a008.js"><link rel="prefetch" href="/assets/js/287.37d52268.js"><link rel="prefetch" href="/assets/js/288.449d562c.js"><link rel="prefetch" href="/assets/js/289.7c642948.js"><link rel="prefetch" href="/assets/js/29.e929240b.js"><link rel="prefetch" href="/assets/js/290.dfcfe424.js"><link rel="prefetch" href="/assets/js/291.6d45cfbc.js"><link rel="prefetch" href="/assets/js/292.d67e83bd.js"><link rel="prefetch" href="/assets/js/293.78d0636a.js"><link rel="prefetch" href="/assets/js/294.a8b470df.js"><link rel="prefetch" href="/assets/js/295.7c8d296f.js"><link rel="prefetch" href="/assets/js/296.5fe4fb70.js"><link rel="prefetch" href="/assets/js/297.7837fbe9.js"><link rel="prefetch" href="/assets/js/298.a5fca25e.js"><link rel="prefetch" href="/assets/js/299.bceec362.js"><link rel="prefetch" href="/assets/js/3.43416577.js"><link rel="prefetch" href="/assets/js/30.f1f91fc1.js"><link rel="prefetch" href="/assets/js/300.4e5d0309.js"><link rel="prefetch" href="/assets/js/301.94edff52.js"><link rel="prefetch" href="/assets/js/302.7710582e.js"><link rel="prefetch" href="/assets/js/303.859504fa.js"><link rel="prefetch" href="/assets/js/304.60a25e30.js"><link rel="prefetch" href="/assets/js/305.ffcb1a83.js"><link rel="prefetch" href="/assets/js/306.3eae4a69.js"><link rel="prefetch" href="/assets/js/307.580a4fa3.js"><link rel="prefetch" href="/assets/js/308.8c2d0635.js"><link rel="prefetch" href="/assets/js/309.83e04b7c.js"><link rel="prefetch" href="/assets/js/31.5a875b4e.js"><link rel="prefetch" href="/assets/js/310.726ed4f7.js"><link rel="prefetch" href="/assets/js/311.ffd0b5c0.js"><link rel="prefetch" href="/assets/js/312.c218f729.js"><link rel="prefetch" href="/assets/js/313.516fb8e4.js"><link rel="prefetch" href="/assets/js/314.cc3db2cd.js"><link rel="prefetch" href="/assets/js/315.51da7822.js"><link rel="prefetch" href="/assets/js/316.a220daf2.js"><link rel="prefetch" href="/assets/js/317.b24db583.js"><link rel="prefetch" href="/assets/js/318.169de969.js"><link rel="prefetch" href="/assets/js/319.aca78575.js"><link rel="prefetch" href="/assets/js/32.94d1b11c.js"><link rel="prefetch" href="/assets/js/320.bcd0a931.js"><link rel="prefetch" href="/assets/js/321.bca84435.js"><link rel="prefetch" href="/assets/js/322.67a4ee6b.js"><link rel="prefetch" href="/assets/js/323.5f51991b.js"><link rel="prefetch" href="/assets/js/324.d0614d23.js"><link rel="prefetch" href="/assets/js/325.5016e4cc.js"><link rel="prefetch" href="/assets/js/326.e8bdcadf.js"><link rel="prefetch" href="/assets/js/327.f063f0a3.js"><link rel="prefetch" href="/assets/js/328.cc9736a6.js"><link rel="prefetch" href="/assets/js/329.3eb72f33.js"><link rel="prefetch" href="/assets/js/33.11f5f34e.js"><link rel="prefetch" href="/assets/js/330.ca9769fa.js"><link rel="prefetch" href="/assets/js/331.efa9b7ad.js"><link rel="prefetch" href="/assets/js/332.a7066755.js"><link rel="prefetch" href="/assets/js/333.127435cc.js"><link rel="prefetch" href="/assets/js/334.b0d2a962.js"><link rel="prefetch" href="/assets/js/335.1dd6e06b.js"><link rel="prefetch" href="/assets/js/336.7beb8f2c.js"><link rel="prefetch" href="/assets/js/337.c8b0b8f9.js"><link rel="prefetch" href="/assets/js/338.ca340dc8.js"><link rel="prefetch" href="/assets/js/339.e9137afb.js"><link rel="prefetch" href="/assets/js/34.6cb1f202.js"><link rel="prefetch" href="/assets/js/340.292132a0.js"><link rel="prefetch" href="/assets/js/341.42efe1ba.js"><link rel="prefetch" href="/assets/js/342.fb94d811.js"><link rel="prefetch" href="/assets/js/343.94ff17d0.js"><link rel="prefetch" href="/assets/js/344.23ee4218.js"><link rel="prefetch" href="/assets/js/345.7ffb185b.js"><link rel="prefetch" href="/assets/js/346.0526c273.js"><link rel="prefetch" href="/assets/js/347.8d90d319.js"><link rel="prefetch" href="/assets/js/348.5bbd93fb.js"><link rel="prefetch" href="/assets/js/349.89f4d5fe.js"><link rel="prefetch" href="/assets/js/35.1ed4a1ee.js"><link rel="prefetch" href="/assets/js/350.53b1f417.js"><link rel="prefetch" href="/assets/js/351.f44c76f7.js"><link rel="prefetch" href="/assets/js/352.93bcc39c.js"><link rel="prefetch" href="/assets/js/353.768257b8.js"><link rel="prefetch" href="/assets/js/354.7e17db07.js"><link rel="prefetch" href="/assets/js/355.7051e33b.js"><link rel="prefetch" href="/assets/js/356.f2368ee3.js"><link rel="prefetch" href="/assets/js/357.8e72e710.js"><link rel="prefetch" href="/assets/js/358.28ab5497.js"><link rel="prefetch" href="/assets/js/36.0abdd3a7.js"><link rel="prefetch" href="/assets/js/37.c88565ed.js"><link rel="prefetch" href="/assets/js/38.f613715e.js"><link rel="prefetch" href="/assets/js/39.4dd2db2f.js"><link rel="prefetch" href="/assets/js/4.abc3f7a4.js"><link rel="prefetch" href="/assets/js/40.1e4e0819.js"><link rel="prefetch" href="/assets/js/41.d6de871f.js"><link rel="prefetch" href="/assets/js/42.28dbeb4a.js"><link rel="prefetch" href="/assets/js/43.1c40a534.js"><link rel="prefetch" href="/assets/js/44.44d031b1.js"><link rel="prefetch" href="/assets/js/45.73584c88.js"><link rel="prefetch" href="/assets/js/46.3d5658a5.js"><link rel="prefetch" href="/assets/js/47.169cd9cf.js"><link rel="prefetch" href="/assets/js/48.6299deec.js"><link rel="prefetch" href="/assets/js/49.626c0799.js"><link rel="prefetch" href="/assets/js/50.6983c478.js"><link rel="prefetch" href="/assets/js/51.b59570ff.js"><link rel="prefetch" href="/assets/js/52.d0f60c7c.js"><link rel="prefetch" href="/assets/js/53.a69c8944.js"><link rel="prefetch" href="/assets/js/54.00c6be71.js"><link rel="prefetch" href="/assets/js/55.b687517e.js"><link rel="prefetch" href="/assets/js/56.df1a2bc4.js"><link rel="prefetch" href="/assets/js/57.c267d867.js"><link rel="prefetch" href="/assets/js/58.a0f8dbda.js"><link rel="prefetch" href="/assets/js/59.3694377f.js"><link rel="prefetch" href="/assets/js/6.526625cd.js"><link rel="prefetch" href="/assets/js/60.bde4bf7d.js"><link rel="prefetch" href="/assets/js/61.d69c73cf.js"><link rel="prefetch" href="/assets/js/62.d73516dc.js"><link rel="prefetch" href="/assets/js/63.b97587c3.js"><link rel="prefetch" href="/assets/js/64.88d68731.js"><link rel="prefetch" href="/assets/js/65.d69fae0f.js"><link rel="prefetch" href="/assets/js/66.3dad6a26.js"><link rel="prefetch" href="/assets/js/67.6b2b51c7.js"><link rel="prefetch" href="/assets/js/68.9fd7767b.js"><link rel="prefetch" href="/assets/js/69.1104440d.js"><link rel="prefetch" href="/assets/js/7.e29355aa.js"><link rel="prefetch" href="/assets/js/70.4edb9e44.js"><link rel="prefetch" href="/assets/js/71.7a53a9cd.js"><link rel="prefetch" href="/assets/js/72.6d2f5334.js"><link rel="prefetch" href="/assets/js/73.e52ef57b.js"><link rel="prefetch" href="/assets/js/74.c1213310.js"><link rel="prefetch" href="/assets/js/75.dba2ed37.js"><link rel="prefetch" href="/assets/js/76.ab65ed14.js"><link rel="prefetch" href="/assets/js/77.ae0657c9.js"><link rel="prefetch" href="/assets/js/78.ec1af670.js"><link rel="prefetch" href="/assets/js/79.afc2d40a.js"><link rel="prefetch" href="/assets/js/8.51e43693.js"><link rel="prefetch" href="/assets/js/80.a9758fac.js"><link rel="prefetch" href="/assets/js/81.ccdc9390.js"><link rel="prefetch" href="/assets/js/82.0b27619a.js"><link rel="prefetch" href="/assets/js/83.fcd9f8bf.js"><link rel="prefetch" href="/assets/js/84.3943eb9f.js"><link rel="prefetch" href="/assets/js/85.0844c4e9.js"><link rel="prefetch" href="/assets/js/86.ee9a5949.js"><link rel="prefetch" href="/assets/js/87.ac07d1b8.js"><link rel="prefetch" href="/assets/js/88.15d5a7c8.js"><link rel="prefetch" href="/assets/js/89.ce28738c.js"><link rel="prefetch" href="/assets/js/9.869e302c.js"><link rel="prefetch" href="/assets/js/90.c428e31f.js"><link rel="prefetch" href="/assets/js/91.da34df0d.js"><link rel="prefetch" href="/assets/js/92.120d04c0.js"><link rel="prefetch" href="/assets/js/93.7ce7cb63.js"><link rel="prefetch" href="/assets/js/94.f061d1d8.js"><link rel="prefetch" href="/assets/js/95.71e8e416.js"><link rel="prefetch" href="/assets/js/96.3e4489d2.js"><link rel="prefetch" href="/assets/js/97.d822ad08.js"><link rel="prefetch" href="/assets/js/98.5d97c226.js"><link rel="prefetch" href="/assets/js/99.9cc35987.js">
    <link rel="stylesheet" href="/assets/css/0.styles.37875d28.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://cdn.staticaly.com/gh/Small-market/imgs@master/logo.2jag6ehlzme0.png" alt="Gavin blog" class="logo"> <span class="site-name can-hide">Gavin blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/navigation/" class="nav-link">导航站</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><a href="/java/" class="link-title">Java</a> <span class="title" style="display:none;">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>java基础</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/se/" class="nav-link">Java基础</a></li><li class="dropdown-subitem"><a href="/java/collection/" class="nav-link">Java集合</a></li><li class="dropdown-subitem"><a href="/java/se/reflect/" class="nav-link">Java反射</a></li><li class="dropdown-subitem"><a href="/java/juc/" class="nav-link">JavaJUC</a></li><li class="dropdown-subitem"><a href="/java/jvm/" class="nav-link">JavaJVM</a></li></ul></li><li class="dropdown-item"><h4>Java容器</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/javaweb/concept/" class="nav-link">JavaWeb</a></li></ul></li><li class="dropdown-item"><h4>Java版本新特性</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/new-features/" class="nav-link">Java新特性</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/database/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>SQL 数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/mysql/" class="nav-link">MySQL</a></li><li class="dropdown-subitem"><a href="/oracle/" class="nav-link">Oracle</a></li></ul></li><li class="dropdown-item"><h4>NoSQL 数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/redis/" class="nav-link">Redis</a></li><li class="dropdown-subitem"><a href="/es/" class="nav-link">ElasticSearch</a></li><li class="dropdown-subitem"><a href="/mongodb/" class="nav-link">MongoDB</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><a href="/frames/" class="link-title">框架</a> <span class="title" style="display:none;">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/mybatis/" class="nav-link">MyBatis</a></li><li class="dropdown-subitem"><a href="/mybatis-plus/" class="nav-link">MyBatis-Plus</a></li></ul></li><li class="dropdown-item"><h4>消息中间件</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/activemq/" class="nav-link">ActiveMQ</a></li><li class="dropdown-subitem"><a href="/rabbitmq/" class="nav-link">RabbitMQ</a></li><li class="dropdown-subitem"><a href="/rocketmq/" class="nav-link">RocketMQ</a></li><li class="dropdown-subitem"><a href="/kafka/" class="nav-link">Kafka</a></li></ul></li><li class="dropdown-item"><h4>进阶服务</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/nginx/" class="nav-link router-link-active">Nginx</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring生态" class="dropdown-title"><a href="/spring-ecology/" class="link-title">Spring生态</a> <span class="title" style="display:none;">Spring生态</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/spring/" class="nav-link">Spring</a></li><li class="dropdown-item"><!----> <a href="/spring-mvc/" class="nav-link">Spring MVC</a></li><li class="dropdown-item"><!----> <a href="/spring-boot/" class="nav-link">Spring Boot</a></li><li class="dropdown-item"><!----> <a href="/spring-security/" class="nav-link">Spring Security</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发" class="dropdown-title"><a href="/dev-guide/" class="link-title">开发</a> <span class="title" style="display:none;">开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/design-pattern/" class="nav-link">设计模式</a></li><li class="dropdown-item"><!----> <a href="/algorithm/" class="nav-link">算法</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><a href="/tool/" class="link-title">工具</a> <span class="title" style="display:none;">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>管理</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/maven/" class="nav-link">Maven</a></li><li class="dropdown-subitem"><a href="/git/" class="nav-link">Git</a></li></ul></li><li class="dropdown-item"><h4>部署</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/linux/" class="nav-link">Linux</a></li><li class="dropdown-subitem"><a href="/docker/" class="nav-link">Docker</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><a href="/front/" class="link-title">前端</a> <span class="title" style="display:none;">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>基础</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/html/" class="nav-link">Html</a></li><li class="dropdown-subitem"><a href="/css/" class="nav-link">css</a></li><li class="dropdown-subitem"><a href="/javascript/" class="nav-link">JavaScript</a></li></ul></li><li class="dropdown-item"><h4>框架</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/react/" class="nav-link">React</a></li><li class="dropdown-subitem"><a href="/vue2/" class="nav-link">Vue2</a></li><li class="dropdown-subitem"><a href="/vue3/" class="nav-link">Vue3</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><!----> <span class="title" style="display:;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/whells-use/" class="nav-link">轮子工具</a></li><li class="dropdown-item"><!----> <a href="/projects/" class="nav-link">项目工程</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>本站</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-subitem"><a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-subitem"><a href="/archives/" class="nav-link">归档</a></li></ul></li><li class="dropdown-item"><h4>我的</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/whell/web/" class="nav-link">收藏</a></li><li class="dropdown-subitem"><a href="/about/website/introduce/" class="nav-link">关于</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/message-area/" class="nav-link">留言区</a></div> <a href="https://github.com/Small-market/Small-market.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://cdn.jsdelivr.net/gh/Small-market/imgs@master/avatar.7osqty57lmg.webp"> <div class="blogger-info"><h3>Gavin</h3> <span>编程之八字真言：八个字：1、专2、静3、谦4、筹5、悟6、慎7、透8、恒。</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/navigation/" class="nav-link">导航站</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><a href="/java/" class="link-title">Java</a> <span class="title" style="display:none;">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>java基础</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/se/" class="nav-link">Java基础</a></li><li class="dropdown-subitem"><a href="/java/collection/" class="nav-link">Java集合</a></li><li class="dropdown-subitem"><a href="/java/se/reflect/" class="nav-link">Java反射</a></li><li class="dropdown-subitem"><a href="/java/juc/" class="nav-link">JavaJUC</a></li><li class="dropdown-subitem"><a href="/java/jvm/" class="nav-link">JavaJVM</a></li></ul></li><li class="dropdown-item"><h4>Java容器</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/javaweb/concept/" class="nav-link">JavaWeb</a></li></ul></li><li class="dropdown-item"><h4>Java版本新特性</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/new-features/" class="nav-link">Java新特性</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/database/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>SQL 数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/mysql/" class="nav-link">MySQL</a></li><li class="dropdown-subitem"><a href="/oracle/" class="nav-link">Oracle</a></li></ul></li><li class="dropdown-item"><h4>NoSQL 数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/redis/" class="nav-link">Redis</a></li><li class="dropdown-subitem"><a href="/es/" class="nav-link">ElasticSearch</a></li><li class="dropdown-subitem"><a href="/mongodb/" class="nav-link">MongoDB</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><a href="/frames/" class="link-title">框架</a> <span class="title" style="display:none;">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/mybatis/" class="nav-link">MyBatis</a></li><li class="dropdown-subitem"><a href="/mybatis-plus/" class="nav-link">MyBatis-Plus</a></li></ul></li><li class="dropdown-item"><h4>消息中间件</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/activemq/" class="nav-link">ActiveMQ</a></li><li class="dropdown-subitem"><a href="/rabbitmq/" class="nav-link">RabbitMQ</a></li><li class="dropdown-subitem"><a href="/rocketmq/" class="nav-link">RocketMQ</a></li><li class="dropdown-subitem"><a href="/kafka/" class="nav-link">Kafka</a></li></ul></li><li class="dropdown-item"><h4>进阶服务</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/nginx/" class="nav-link router-link-active">Nginx</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring生态" class="dropdown-title"><a href="/spring-ecology/" class="link-title">Spring生态</a> <span class="title" style="display:none;">Spring生态</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/spring/" class="nav-link">Spring</a></li><li class="dropdown-item"><!----> <a href="/spring-mvc/" class="nav-link">Spring MVC</a></li><li class="dropdown-item"><!----> <a href="/spring-boot/" class="nav-link">Spring Boot</a></li><li class="dropdown-item"><!----> <a href="/spring-security/" class="nav-link">Spring Security</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发" class="dropdown-title"><a href="/dev-guide/" class="link-title">开发</a> <span class="title" style="display:none;">开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/design-pattern/" class="nav-link">设计模式</a></li><li class="dropdown-item"><!----> <a href="/algorithm/" class="nav-link">算法</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><a href="/tool/" class="link-title">工具</a> <span class="title" style="display:none;">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>管理</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/maven/" class="nav-link">Maven</a></li><li class="dropdown-subitem"><a href="/git/" class="nav-link">Git</a></li></ul></li><li class="dropdown-item"><h4>部署</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/linux/" class="nav-link">Linux</a></li><li class="dropdown-subitem"><a href="/docker/" class="nav-link">Docker</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><a href="/front/" class="link-title">前端</a> <span class="title" style="display:none;">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>基础</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/html/" class="nav-link">Html</a></li><li class="dropdown-subitem"><a href="/css/" class="nav-link">css</a></li><li class="dropdown-subitem"><a href="/javascript/" class="nav-link">JavaScript</a></li></ul></li><li class="dropdown-item"><h4>框架</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/react/" class="nav-link">React</a></li><li class="dropdown-subitem"><a href="/vue2/" class="nav-link">Vue2</a></li><li class="dropdown-subitem"><a href="/vue3/" class="nav-link">Vue3</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><!----> <span class="title" style="display:;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/whells-use/" class="nav-link">轮子工具</a></li><li class="dropdown-item"><!----> <a href="/projects/" class="nav-link">项目工程</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>本站</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-subitem"><a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-subitem"><a href="/archives/" class="nav-link">归档</a></li></ul></li><li class="dropdown-item"><h4>我的</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/whell/web/" class="nav-link">收藏</a></li><li class="dropdown-subitem"><a href="/about/website/introduce/" class="nav-link">关于</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/message-area/" class="nav-link">留言区</a></div> <a href="https://github.com/Small-market/Small-market.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MyBatis</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MyBatis-Plus</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>中间件 - ActiveMQ</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>中间件 - RabbitMQ</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>中间件 - RocketMQ</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>中间件 - Kafka</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>高性能服务器 - Nginx</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/nginx/introduce/" class="sidebar-link">Nginx - 介绍</a></li><li><a href="/nginx/install/" class="sidebar-link">Nginx - 环境准备</a></li><li><a href="/niginx/commands/" class="sidebar-link">Nginx - 基础指令</a></li><li><a href="/nginx/config/" class="sidebar-link">Nginx - 核心配置文件</a></li><li><a href="/nginx/example/" class="sidebar-link">Nginx - 配置巩固实例</a></li><li><a href="/nginx/static-doploy/" class="sidebar-link">Nginx - 静态资源部署</a></li><li><a href="/nginx/static-visit/" class="sidebar-link">Nginx - 静态资源访问</a></li><li><a href="/nginx/reverse-proxy/" class="sidebar-link">Nginx - 反向代理</a></li><li><a href="/nginx/load-balancing/" class="sidebar-link">Nginx - 负载均衡</a></li><li><a href="/nginx/cache-integration/" class="sidebar-link">Nginx - 缓存集成</a></li><li><a href="/nginx/deploy-cluster/" aria-current="page" class="active sidebar-link">Nginx - 部署与集群</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/nginx/deploy-cluster/#nginx与tomcat部署" class="sidebar-link">Nginx与Tomcat部署</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/nginx/deploy-cluster/#环境准备-tomcat" class="sidebar-link">环境准备(Tomcat)</a></li><li class="sidebar-sub-header level3"><a href="/nginx/deploy-cluster/#环境准备-nginx" class="sidebar-link">环境准备(Nginx)</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/nginx/deploy-cluster/#动静分离" class="sidebar-link">动静分离</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/nginx/deploy-cluster/#需求分析" class="sidebar-link">需求分析</a></li><li class="sidebar-sub-header level3"><a href="/nginx/deploy-cluster/#实现步骤" class="sidebar-link">实现步骤</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/nginx/deploy-cluster/#tomcat集群搭建" class="sidebar-link">Tomcat集群搭建</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/nginx/deploy-cluster/#环境搭建" class="sidebar-link">环境搭建</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/nginx/deploy-cluster/#nginx集群搭建" class="sidebar-link">Nginx集群搭建</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/nginx/deploy-cluster/#keepalived" class="sidebar-link">Keepalived</a></li><li class="sidebar-sub-header level3"><a href="/nginx/deploy-cluster/#vrrp介绍" class="sidebar-link">VRRP介绍</a></li><li class="sidebar-sub-header level3"><a href="/nginx/deploy-cluster/#环境搭建-2" class="sidebar-link">环境搭建</a></li><li class="sidebar-sub-header level3"><a href="/nginx/deploy-cluster/#keepalived配置文件介绍" class="sidebar-link">Keepalived配置文件介绍</a></li><li class="sidebar-sub-header level3"><a href="/nginx/deploy-cluster/#vrrp-instance" class="sidebar-link">vrrp_instance</a></li><li class="sidebar-sub-header level3"><a href="/nginx/deploy-cluster/#服务器配置" class="sidebar-link">服务器配置</a></li><li class="sidebar-sub-header level3"><a href="/nginx/deploy-cluster/#访问测试" class="sidebar-link">访问测试</a></li><li class="sidebar-sub-header level3"><a href="/nginx/deploy-cluster/#vrrp-script" class="sidebar-link">vrrp_script</a></li></ul></li></ul></li><li><a href="/nginx/site-auth/" class="sidebar-link">Nginx - 站点与认证</a></li><li><a href="/nginx/lau/" class="sidebar-link">Nginx - Lau学习</a></li><li><a href="/nginx/modules/" class="sidebar-link">Nginx - Lua扩展模块</a></li><li><a href="/nginx/ngx-lua-table/" class="sidebar-link">Nginx - Lua模块文档表</a></li><li><a href="/nginx/images/" class="sidebar-link">Nginx - 自定义镜像</a></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/categories/?category=%E6%A1%86%E6%9E%B6" title="分类" data-v-06225672>框架</a></li><li data-v-06225672><a href="/categories/?category=%E9%AB%98%E6%80%A7%E8%83%BD%E6%9C%8D%E5%8A%A1%E5%99%A8%20-%20Nginx" title="分类" data-v-06225672>高性能服务器 - Nginx</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/Small-market" target="_blank" title="作者" class="beLink" data-v-06225672>Gavin</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2021-11-29</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">Nginx - 部署与集群<!----></h1> <!----> <div class="theme-vdoing-content content__default"><div class="custom-block note"><p class="custom-block-title">笔记</p> <p>Nginx 接收用户的请求后如何把请求转发到后台 Web 服务器？Nginx 如何实现动静分离？Nginx 又如何实现集群搭建，本内容将带大家学习 Nginx 的部署与集群知识。</p> <div class="custom-block right"><p>2021-11-29 @Gavin</p></div></div> <p></p><div class="table-of-contents"><ul><li><a href="#nginx与tomcat部署">Nginx与Tomcat部署</a><ul><li><a href="#环境准备-tomcat">环境准备(Tomcat)</a></li><li><a href="#环境准备-nginx">环境准备(Nginx)</a></li></ul></li><li><a href="#动静分离">动静分离</a><ul><li><a href="#需求分析">需求分析</a></li><li><a href="#实现步骤">实现步骤</a></li></ul></li><li><a href="#tomcat集群搭建">Tomcat集群搭建</a><ul><li><a href="#环境搭建">环境搭建</a></li></ul></li><li><a href="#nginx集群搭建">Nginx集群搭建</a><ul><li><a href="#keepalived">Keepalived</a></li><li><a href="#vrrp介绍">VRRP介绍</a></li><li><a href="#环境搭建">环境搭建</a></li><li><a href="#keepalived配置文件介绍">Keepalived配置文件介绍</a></li><li><a href="#vrrp-instance">vrrp_instance</a></li><li><a href="#服务器配置">服务器配置</a></li><li><a href="#访问测试">访问测试</a></li><li><a href="#vrrp-script">vrrp_script</a></li></ul></li></ul></div><p></p> <h2 id="nginx与tomcat部署"><a href="#nginx与tomcat部署" class="header-anchor">#</a> Nginx与Tomcat部署</h2> <p>前面已经将 Nginx 的大部分内容进行了讲解，我们都知道了 Nginx 在高并发场景和处理静态资源是非常高性能的，但是在实际项目中除了静态资源还有就是后台业务代码模块，一般后台业务都会被部署在 Tomcat、weblogic 或者是 websphere 等 Web 服务器上。那么如何使用 Nginx 接收用户的请求并把请求转发到后台 Web 服务器？</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Nginx/20211130172629.png" alt="1604498725652"></p> <p>步骤分析:</p> <ul><li>在服务器 A 上准备 Tomcat 环境，并在 Tomcat 上部署一个 Web 项目。这步骤在 <a href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87-tomcat">环境准备(Tomcat)</a></li> <li>在服务器 B 上准备 Nginx 环境，使用 Nginx 接收请求，并把请求分发到 Tomcat 上。这步骤在 <a href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87-nginx">环境准备(Nginx)</a></li></ul> <h3 id="环境准备-tomcat"><a href="#环境准备-tomcat" class="header-anchor">#</a> 环境准备(Tomcat)</h3> <p>本次将采用 Tomcat 作为后台 Web 服务器。</p> <ul><li><p>在 服务器 A 上准备一个 Tomcat</p> <ul><li>Tomcat 官网地址：<a href="https://tomcat.apache.org/" target="_blank" rel="noopener noreferrer">https://tomcat.apache.org/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li> <li><p>下载 Tomcat，这里使用的是 <code>apache-tomcat-9.0.54.tar.gz</code></p></li> <li><p>进入上传目录，将 Tomcat 进行解压缩</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function">mkdir</span> /usr/local/tomcat

<span class="token function">tar</span> -zxf apache-tomcat-9.0.54.tar.gz -C /usr/local/tomcat
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p>准备一个 Web 项目，将其打包为 War 包，这里是 demo.war</p> <ul><li><p>将写好的 War 包上传到 Tomcat 目录下的 webapps 包下</p></li> <li><p>将 Tomcat 进行启动，进入 Tomcat 的 bin 目录下，执行命令：</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>./startup.sh
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ul></li> <li><p>启动完成 Tomcat 后，进行访问测试</p> <p>浏览器访问：</p> <ul><li><p>静态资源：<code>http://192.168.200.146:8080/demo/index.html</code></p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Nginx/20211129123846.png" alt="image-20211129123837835"></p></li> <li><p>动态资源：<code>http://192.168.200.146:8080/demo/getAddress</code></p> <p>动态资源可以是端口号，此时的端口是 8080</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Nginx/20211129124819.png" alt="image-20211129124753971"></p></li></ul></li></ul> <p>自此，服务器 A 的 Tomcat 部署已经实现。</p> <p><strong>demo.war 的内容有什么呢？</strong></p> <p>其实你可以自己制作一个 war 包，这里说明一下，demo.war 里有两个图片，和一个 index.html</p> <p>index.html 文件引用了两个图片：</p> <div class="language-html line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br></div><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Title<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>js/jquery.min.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
        <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
           $<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'http://192.168.200.133/demo/getAddress'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
               <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#msg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>images/logo.png<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Nginx如何将请求转发到后端服务器<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>msg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>images/mv.png<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>可以看出，当访问 index.html 时，它会主动去请求 <code>/getAddress</code>，这个请求返回端口号，即把 8080 当作动态资源，显示到页面上，如果是 9090 端口访问，则返回 9090 显示页面上。你也可以直接访问 <code>/getAddress</code>，直接获取端口号。</p> <h3 id="环境准备-nginx"><a href="#环境准备-nginx" class="header-anchor">#</a> 环境准备(Nginx)</h3> <p>我们已经在 Tomcat 实现了两个效果，那么现在需要把 Tomcat 的地址放到 Nginx 里，由 Nginx 帮我们代理这个 Tomcat 地址，这样我们访问 Nginx，实际上就是访问 Tomcat。</p> <p>（1）使用 Nginx 的反向代理，将请求转给 Tomcat 进行处理。</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">upstream</span> webservice</span> <span class="token punctuation">{</span>
	<span class="token directive"><span class="token keyword">server</span> 192.168.200.146:8080</span><span class="token punctuation">;</span>  <span class="token comment"># 服务器 A 的 Tomcat  地址</span>
<span class="token punctuation">}</span>
<span class="token directive"><span class="token keyword">server</span></span><span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span>		<span class="token number">80</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span> localhost</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">location</span> /demo</span> <span class="token punctuation">{</span>
    	<span class="token directive"><span class="token keyword">proxy_pass</span> http://webservice</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>（2）启动访问服务器 B，测试是否代理到服务器 A 的 Tomcat，效果如图：</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Nginx/20211129124916.png" alt="1604421312486"></p> <p>学习到这，可能大家会有一个困惑，明明直接通过 Tomcat 就能访问，为什么还需要多加一个 Nginx，这样不是反而是系统的复杂度变高了么?
那接下来我们从两个方便给大家分析下这个问题，</p> <ul><li><p>第一个使用 Nginx 实现动静分离</p></li> <li><p>第二个使用 Nginx 搭建 Tomcat 的集群</p></li></ul> <h2 id="动静分离"><a href="#动静分离" class="header-anchor">#</a> 动静分离</h2> <p><strong>什么是动静分离？</strong></p> <ul><li>动：后台应用程序的业务处理</li> <li>静：网站的静态资源（html，javaScript，css，images 等文件）</li> <li>分离：将两者进行分开部署访问，提供用户进行访问。</li></ul> <p><strong>举例说明就是以后所有和静态资源相关的内容都交给 Nginx 来部署访问，非静态内容则交个类似于 Tomcat 的服务器来部署访问。</strong></p> <p><strong>为什么要动静分离？</strong></p> <p>前面我们介绍过 Nginx 在处理静态资源的时候，效率是非常高的，而且 Nginx 的并发访问量也是名列前茅，而 Tomcat 则相对比较弱一些，所以把静态资源交给 Nginx 后，可以减轻 Tomcat 服务器的访问压力并提高静态资源的访问速度。</p> <p>动静分离以后，降低了动态资源和静态资源的耦合度。如动态资源宕机了也不影响静态资源的展示。</p> <p><strong>如何实现动静分离?</strong></p> <p>实现动静分离的方式很多，比如静态资源可以部署到 CDN、Nginx 等服务器上，动态资源可以部署到 Tomcat、weblogic 或者 websphere 上。这里使用 Nginx + Tomcat 来实现动静分离。</p> <h3 id="需求分析"><a href="#需求分析" class="header-anchor">#</a> 需求分析</h3> <p>如下图，因为 Nginx 处理静态资源性能高，所以我们把静态资源放在 Nginx 服务器上，然后把动态资源放到 Tomcat 服务器上。当访问 Nginx 的静态资源时，Nginx 会去访问 Tocmat 获取动态资源。实现动静分离。</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Nginx/20211129150518.png" alt="1604422564855"></p> <h3 id="实现步骤"><a href="#实现步骤" class="header-anchor">#</a> 实现步骤</h3> <ul><li><p>将 demo.war 项目中的静态资源（两个图片）都删除掉，重新打包生成一个 War 包</p> <p>这时候 War 包只留下动态资源，而静态资源要放到 Nginx 上。</p></li> <li><p>将新的 War 包部署到 Tomcat 中，把之前部署的内容删除掉</p> <ul><li><p>进入到 tomcat 的 webapps 目录下，将之前的 demo 目录和 demo.war 包删除掉</p></li> <li><p>将新的 War 包复制到 webapps 下</p></li> <li><p>将 tomcat 启动</p></li></ul></li> <li><p>在 Nginx 所在的服务器 B 上创建如下目录，并将对应的静态资源放入指定的位置</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Nginx/20211129151615.png" alt="1604493947499"></p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function">mkdir</span> /usr/local/nginx/html/web/images
<span class="token function">mkdir</span> /usr/local/nginx/html/web/js

<span class="token function">cp</span> logo.png /usr/local/nginx/html/web/images
<span class="token function">cp</span> mv.png /usr/local/nginx/html/web/images
<span class="token function">cp</span> jquery.min.js /usr/local/nginx/html/web/js

<span class="token function">vim</span> /usr/local/nginx/html/web/index.html
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>其中 index.html 页面的内容如下:</p> <div class="language-html line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Title<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>js/jquery.min.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
        <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
           $<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'http://192.168.200.133/demo/getAddress'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
               <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#msg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>images/logo.png<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Nginx如何将请求转发到后端服务器<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>msg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>images/mv.png<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>第 9 行代码，它访问的这个地址是服务器 B 的 Nginx，通过这个地址让 Nginx 去获取服务器 A 的 Tomcat 动态资源。</p></li> <li><p>在配置文件配置 Nginx 的静态资源与动态资源的访问</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">upstream</span> webservice</span><span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">server</span> 192.168.200.146:8080</span><span class="token punctuation">;</span>  <span class="token comment"># 服务器 A 的 Tocmat</span>
<span class="token punctuation">}</span>
<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">80</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span>  localhost</span><span class="token punctuation">;</span>

    <span class="token comment"># 动态资源从 Tomcat 获取</span>
    <span class="token directive"><span class="token keyword">location</span> /demo</span> <span class="token punctuation">{</span>     		 <span class="token comment"># index.html 第 9 行代码触发该 location</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span> http://webservice</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment"># 静态资源从自己身上获取</span>
    <span class="token directive"><span class="token keyword">location</span> ~/.*\.(png|jpg|gif|js)</span><span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">root</span> html/web</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">gzip</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">root</span>   html/web</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">index</span>  index.html index.htm</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div></li> <li><p>启动测试，访问 <code>http://192.168.200.133</code></p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Nginx/20211129150848.png" alt="1604494128097"></p> <p>假如某个时间点，由于某个原因导致 Tomcat 后的服务器宕机了，我们再次访问 Nginx，会得到如下效果：</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Nginx/20211129152116.png" alt="1604494156197"></p> <p>用户还是能看到页面，只是缺失 Tomcat 的动态资源，这就是前后端耦合度降低的效果，并且整个请求只和后的服务器交互了一次，js 和 images 都直接从 Nginx 服务器里返回，提供了效率，降低了后端服务器的压力。</p></li></ul> <h2 id="tomcat集群搭建"><a href="#tomcat集群搭建" class="header-anchor">#</a> Tomcat集群搭建</h2> <p>在使用 Nginx 和 Tomcat 部署项目的时候，我们使用的是一台 Nginx 服务器和一台 Tomcat 服务器，效果图如下：</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Nginx/20211129152253.png" alt="1604494256017"></p> <p>那么问题来了，如果 Tomcat 的真的宕机了，整个系统就会不完整，所以如何解决上述问题？</p> <p>一台服务器容易宕机，那就多搭建几台 Tomcat 服务器，这样的话就提升了后的服务器的可用性。这也就是我们常说的集群，搭建 Tomcat 的集群需要用到了 Nginx 的反向代理和赋值均衡的知识，具体如何来实现？</p> <p>我们先来分析下原理：</p> <p>用户请求到 Nginx，Nginx 使用负载均衡对三个 Tomcat 服务器进行访问，如果一个 Tomcat 服务器宕机了，那么还有两个 Tomcat 服务器可以使用。</p> <p>如图：</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Nginx/20211129152549.png" alt="1604494269848"></p> <h3 id="环境搭建"><a href="#环境搭建" class="header-anchor">#</a> 环境搭建</h3> <p>（1）准备 3 台 Tomcat 服务器，使用端口进行区分（实际环境应该是三台服务器），修改 Tomcat 的 server.xml，将端口修改分别修改为 8080、8180、8280</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function">cp</span> -r apache-tomcat-9.0.54 tomcat01
<span class="token function">cp</span> -r apache-tomcat-9.0.54 tomcat02
<span class="token function">cp</span> -r apache-tomcat-9.0.54 tomcat03
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>修改三个 Tocmat 配置文件的端口</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function">vim</span> tomcat01/conf/server.xml
<span class="token function">vim</span> tomcat02/conf/server.xml
<span class="token function">vim</span> tomcat03/conf/server.xml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>修改的内容位置如下：</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Nginx/20211129153013.png" alt="image-20211129153012231"></p> <p>（2）启动 Tomcat 并访问测试，</p> <div class="language-http line-numbers-mode"><pre class="language-http"><code><span class="token header"><span class="token header-name keyword">http</span><span class="token punctuation">:</span><span class="token header-value">//192.168.200.146:8080/demo/getAddress</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Nginx/20211129153044.png" alt="1604494822961"></p> <div class="language-http line-numbers-mode"><pre class="language-http"><code><span class="token header"><span class="token header-name keyword">http</span><span class="token punctuation">:</span><span class="token header-value">//192.168.200.146:8180/demo/getAddress</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Nginx/20211129153046.png" alt="1604494843886"></p> <div class="language-http line-numbers-mode"><pre class="language-http"><code><span class="token header"><span class="token header-name keyword">http</span><span class="token punctuation">:</span><span class="token header-value">//192.168.200.146:8280/demo/getAddress</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Nginx/20211129153048.png" alt="1604494860954"></p> <p>(3)在 Nginx 对应的配置文件中添加如下内容:</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">upstream</span> webservice</span><span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">server</span> 192.168.200.146:8080</span><span class="token punctuation">;</span>     <span class="token comment"># tomcat01</span>
    <span class="token directive"><span class="token keyword">server</span> 192.168.200.146:8180</span><span class="token punctuation">;</span> 	 <span class="token comment"># tomcat02</span>
    <span class="token directive"><span class="token keyword">server</span> 192.168.200.146:8280</span><span class="token punctuation">;</span>	 <span class="token comment"># tomcat03</span>
<span class="token punctuation">}</span>
<span class="token directive"><span class="token keyword">server</span></span><span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span>		<span class="token number">80</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span> localhost</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">location</span> /demo</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span> http://webservice</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>好了，完成了上述环境的部署，我们已经解决了 Tomcat 的高可用性，一台服务器宕机，还有其他两条对外提供服务，同时也可以实现后台服务器的不间断更新。</p> <p><strong>但是新问题出现了，上述环境中，如果是 Nginx 宕机了呢，那么整套系统都将服务对外提供服务了，这个如何解决？</strong></p> <h2 id="nginx集群搭建"><a href="#nginx集群搭建" class="header-anchor">#</a> Nginx集群搭建</h2> <p>针对于上面提到的问题，我们来分析下要想解决上述问题，需要面临哪些问题？</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Nginx/20211129153455.png" alt="1604495169905"></p> <p>需要两台以上的 Nginx 服务器对外提供服务，这样的话就可以解决其中一台宕机了，另外一台还能对外提供服务，但是如果是两台 Nginx 服务器的话，会有两个 IP 地址，用户该访问哪台服务器，用户怎么知道哪台是好的，哪台是宕机了的？</p> <h3 id="keepalived"><a href="#keepalived" class="header-anchor">#</a> Keepalived</h3> <p>使用 Keepalived 来解决，Keepalived 软件由 C 编写的，最初是专为 LVS 负载均衡软件设计的，Keepalived 软件主要是通过 VRRP 协议实现高可用功能。</p> <h3 id="vrrp介绍"><a href="#vrrp介绍" class="header-anchor">#</a> VRRP介绍</h3> <p>VRRP（Virtual Route Redundancy Protocol）协议，翻译过来为虚拟路由冗余协议。VRRP 协议将两台或多台路由器设备虚拟成一个设备，对外提供虚拟路由器 IP，而在路由器组内部，如果实际拥有这个对外 IP 的路由器如果工作正常的话就是 MASTER，MASTER 实现针对虚拟路由器IP的各种网络功能。其他设备不拥有该虚拟 IP，状态为 BACKUP，处了接收 MASTER 的 VRRP 状态通告信息以外，不执行对外的网络功能。当主机失效时，BACKUP 将接管原先 MASTER 的网络功能。</p> <p>看图分析：VRRP 把两个 Nginx 分成两个路由（VRRP 路由 1 和 VRRP 路由 2），并生成一个 Virtual 路由，用户访问的是 Virtual 路由，该路由会去访问两个 Nginx 生成的 VRRP 路由。那么到底访问谁呢？VRRP 会给两个路由分配角色，一个是 Master（老大），另一个是 Backup（备份），所以访问的是 Master 角色的路由，当 Master 角色路由宕机了，才会找到 Backup 备份路由。</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Nginx/20211129153516.png" alt="1604495824757"></p> <p>从上面的介绍信息获取到的内容就是 VRRP 是一种协议，那这个协议是用来干什么的？</p> <ol><li><p>选择协议</p> <p>VRRP 可以把一个虚拟路由器的责任动态分配到局域网上的 VRRP 路由器中的一台。其中的虚拟路由即 Virtual 路由是由 VRRP 路由群组创建的一个不真实存在的路由，这个虚拟路由也是有对应的 IP 地址。而且 VRRP 路由 1 和 VRRP 路由 2 之间会有竞争选择，通过选择会产生一个 Master 路由和一个 Backup 路由。</p></li> <li><p>路由容错协议</p> <p>Master 路由和 Backup 路由之间会有一个心跳检测，Master 会定时告知 Backup 自己的状态，如果在指定的时间内，Backup 没有接收到这个通知内容，Backup 就会替代 Master 成为新的 Master。Master 路由有一个特权就是虚拟路由和后端服务器都是通过 Master 进行数据传递交互的，而备份节点则会直接丢弃这些请求和数据，不做处理，只是去监听 Master 的状态。</p></li></ol> <p>用了 Keepalived 后，解决方案如图下:</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Nginx/20211129153526.png" alt="1604495442179"></p> <p>看图分析：VIP 是虚拟路由，是专门给用户发送请求。一旦用户发送请求到 VIP，VIP 就会发送给 Master（主）的 Nginx，如果 Master（主）Nginx 宕机了，才会发送给 Backup（备份） Nginx 路由。</p> <h3 id="环境搭建-2"><a href="#环境搭建-2" class="header-anchor">#</a> 环境搭建</h3> <p>环境准备</p> <table><thead><tr><th>VIP IP</th> <th>Nginx IP</th> <th>主机名</th> <th>主/从</th></tr></thead> <tbody><tr><td></td> <td>192.168.200.133（服务器 A）</td> <td>keepalived1</td> <td>Master</td></tr> <tr><td>192.168.200.222</td> <td></td> <td></td> <td></td></tr> <tr><td></td> <td>192.168.200.122（服务器 B）</td> <td>keepalived2</td> <td>Backup</td></tr></tbody></table> <p><strong>确保服务器 A 和服务器 B 的 Nginx 配置保持一致。</strong></p> <p>keepalived 的安装步骤如下：</p> <ul><li><p>步骤1：从官方网站下载 keepalived，官网地址 <a href="https://keepalived.org/" target="_blank" rel="noopener noreferrer">https://keepalived.org/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p>步骤2：将下载的资源上传到服务器，这里是 <code>keepalived-2.0.20.tar.gz</code></p></li> <li><p>步骤3：在 <code>/opt</code> 目录下创建 keepalived 目录，方便管理资源</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function">mkdir</span> /opt/keepalived
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>步骤4：将压缩文件进行解压缩，解压缩到指定的目录</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function">tar</span> -zxf keepalived-2.0.20.tar.gz -C /opt/keepalived
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>步骤5：对 keepalived 进行配置，编译和安装</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /opt/keepalived/keepalived-2.0.20

./configure --sysconf<span class="token operator">=</span>/etc --prefix<span class="token operator">=</span>/usr/local   <span class="token comment"># 安装到 /usr/local 目录下，可修改</span>

<span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li></ul> <p><strong>两台 Nginx 服务器都要安装 keepalive。</strong></p> <p>安装完成后，有两个文件需要我们认识下：</p> <ul><li><p><code>/etc/keepalived/keepalived.conf</code>：keepalived 的系统配置文件，我们主要操作的就是该文件</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Nginx/20211129155700.png" alt="image-20211129155635556"></p></li> <li><p><code>/usr/local/sbin</code> 目录下的 <code>keepalived</code>：这是系统配置脚本，用来启动和关闭 keepalived</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Nginx/20211129155657.png" alt="image-20211129155656699"></p></li></ul> <h3 id="keepalived配置文件介绍"><a href="#keepalived配置文件介绍" class="header-anchor">#</a> Keepalived配置文件介绍</h3> <p>打开 keepalived.conf 配置文件</p> <p>这里面会分三部：</p> <ul><li><p>第一部分是 global 全局配置</p></li> <li><p>第二部分是 vrrp 相关配置</p></li> <li><p>第三部分是 LVS 相关配置。</p></li></ul> <p>这里主要是使用 keepalived 实现高可用部署，没有用到 LVS，所以我们重点关注的是前两部分。</p> <p>打开 keepalived.conf 文件</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function">vim</span> /etc/keepalived/keepalived.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>文件内容部分介绍如下：</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token comment"># global全局部分</span>
<span class="token directive"><span class="token keyword">global_defs</span></span> <span class="token punctuation">{</span>
    
   <span class="token directive"><span class="token keyword">notification_email</span></span> <span class="token punctuation">{</span>  <span class="token comment"># 通知邮件，当 keepalived 切换 Master 和 Backup 时需要发 email 给具体的邮箱地址</span>
     tom@itcast.cn
     jerry@itcast.cn
   <span class="token punctuation">}</span>
   notification_email_from kele@Gavin.com   <span class="token comment"># 设置发件人的邮箱信息</span>
   
   smtp_server 192.168.200.1   <span class="token comment"># 指定 smpt 服务地址</span>
   
   smtp_connect_timeout 30   <span class="token comment"># 指定 smpt 服务连接超时时间</span>
   
   router_id LVS_DEVEL   <span class="token comment"># 运行 keepalived 服务器的一个标识，可以用作发送邮件的主题信息</span>
   
   <span class="token comment"># 默认是不跳过检查。检查收到的 VRRP 通告中的所有地址可能会比较耗时，设置此命令的意思是，如果通告与接收的上一个通告来自相同的 master 路由器，则不执行检查(跳过检查)</span>
   vrrp_skip_check_adv_addr
   
   vrrp_strict    <span class="token comment"># 严格遵守 VRRP 协议</span>
  
   vrrp_garp_interval 0   <span class="token comment"># 在一个接口发送的两个免费 ARP 之间的延迟。可以精确到毫秒级。默认是 0</span>
   
   vrrp_gna_interval 0  <span class="token comment"># 在一个网卡上每组消息之间的延迟时间，默认为 0</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>这里需要修改的是 5、6、8 行代码。</p> <p>VRRP 部分可以包含以下四个子模块：</p> <ol><li><p>vrrp_script</p></li> <li><p>vrrp_sync_group</p></li> <li><p>garp_group</p></li> <li><p>vrrp_instance</p></li></ol> <p>我们会用到第一个（<a href="#vrrp-script">vrrp_script</a>）和第四个（<a href="#vrrp-instance">vrrp_instance</a>）。</p> <h3 id="vrrp-instance"><a href="#vrrp-instance" class="header-anchor">#</a> vrrp_instance</h3> <p><code>vrrp_instance</code> 模块内容：</p> <div class="language-nginx line-numbers-mode"><div class="highlight-lines"><br><br><div class="highlighted"> </div><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><div class="highlighted"> </div><br><br><br></div><pre class="language-nginx"><code><span class="token comment"># 设置 keepalived 实例的相关信息，VI_1 为 VRRP 实例名称</span>
<span class="token directive"><span class="token keyword">vrrp_instance</span> VI_1</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">state</span> MASTER  		  <span class="token comment"># 有两个值可选 MASTER 主，BACKUP 备</span>
    interface ens33		  <span class="token comment"># vrrp 实例绑定的接口，用于发送 VRRP 包[当前服务器使用的网卡名称]</span>
    virtual_router_id <span class="token number">51</span>  <span class="token comment"># 指定 VRRP 实例 ID，范围是 0-255</span>
    priority <span class="token number">100</span>		  <span class="token comment"># 指定优先级，优先级高的将成为 MASTER</span>
    advert_int <span class="token number">1</span>		  <span class="token comment"># 指定发送 VRRP 通告的间隔，单位是秒。这里是心跳检查的时间</span>
    authentication</span> <span class="token punctuation">{</span>	  <span class="token comment"># vrrp 之间通信的认证信息</span>
        auth_type PASS	  <span class="token comment"># 指定认证方式。PASS 简单密码认证(推荐)</span>
        auth_pass 1111	  <span class="token comment"># 指定认证使用的密码，最多 8 位</span>
    <span class="token punctuation">}</span>
    <span class="token directive"><span class="token keyword">virtual_ipaddress</span></span> <span class="token punctuation">{</span>   <span class="token comment"># 虚拟 IP 地址设置虚拟 IP 地址，供用户访问使用，可设置多个，一行一个</span>
        192.168.200.222
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><code>vrrp_instance</code> 模块中我们修改的是第 3、5、6、7、13 行代码。</p> <p>第 3 行代码是说明当前 Nginx 服务器的角色是 Master 还是 Backup。分别在服务器 A 和 B 进行角色配置。</p> <p>第 5 行代码是 VIP 的 ID，如果使用相同的虚拟路由 VIP，请保持 ID 一致。</p> <p>第 6 行代码是优先级，请让 Master 服务器的优先级大于 Backup 服务器的优先级。如 100 &gt; 90。</p> <p>第 7 行代码是 Master 和 Backup 之间通信的间隔时间，如果无法通信，说明 Master 已经宕机，则切换为 Backup。</p> <p>第 13 行代码是用户访问的虚拟 IP 地址，即 VIP，它会发送给 Nginx 服务器。</p> <h3 id="服务器配置"><a href="#服务器配置" class="header-anchor">#</a> 服务器配置</h3> <p>Keepalived 的具体配置内容如下：</p> <div class="theme-code-group" data-v-2f5f1757><div class="theme-code-group__nav" data-v-2f5f1757><ul class="theme-code-group__ul" data-v-2f5f1757></ul></div> <div class="theme-code-block theme-code-block__active" data-v-4f1e9d0c><div class="language-nginx line-numbers-mode" data-v-4f1e9d0c><pre class="language-nginx" data-v-4f1e9d0c><code data-v-4f1e9d0c><span class="token directive" data-v-4f1e9d0c><span class="token keyword" data-v-4f1e9d0c>global_defs</span></span> <span class="token punctuation" data-v-4f1e9d0c>{</span>
   <span class="token directive" data-v-4f1e9d0c><span class="token keyword" data-v-4f1e9d0c>notification_email</span></span> <span class="token punctuation" data-v-4f1e9d0c>{</span>
        tom@itcast.cn
        jerry@itcast.cn
   <span class="token punctuation" data-v-4f1e9d0c>}</span>
   notification_email_from zhaomin@itcast.cn
   smtp_server 192.168.200.1
   smtp_connect_timeout 30
   router_id keepalived1
   vrrp_skip_check_adv_addr
   vrrp_strict
   vrrp_garp_interval 0
   vrrp_gna_interval 0
<span class="token punctuation" data-v-4f1e9d0c>}</span>

<span class="token directive" data-v-4f1e9d0c><span class="token keyword" data-v-4f1e9d0c>vrrp_instance</span> VI_1</span> <span class="token punctuation" data-v-4f1e9d0c>{</span>
    <span class="token directive" data-v-4f1e9d0c><span class="token keyword" data-v-4f1e9d0c>state</span> MASTER
    interface ens33
    virtual_router_id <span class="token number" data-v-4f1e9d0c>51</span>
    priority <span class="token number" data-v-4f1e9d0c>100</span>
    advert_int <span class="token number" data-v-4f1e9d0c>1</span>
    authentication</span> <span class="token punctuation" data-v-4f1e9d0c>{</span>
        auth_type PASS
        auth_pass 1111
    <span class="token punctuation" data-v-4f1e9d0c>}</span>
    <span class="token directive" data-v-4f1e9d0c><span class="token keyword" data-v-4f1e9d0c>virtual_ipaddress</span></span> <span class="token punctuation" data-v-4f1e9d0c>{</span>
        192.168.200.222
    <span class="token punctuation" data-v-4f1e9d0c>}</span>
<span class="token punctuation" data-v-4f1e9d0c>}</span>
</code></pre> <div class="line-numbers-wrapper" data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>1</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>2</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>3</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>4</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>5</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>6</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>7</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>8</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>9</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>10</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>11</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>12</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>13</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>14</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>15</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>16</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>17</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>18</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>19</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>20</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>21</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>22</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>23</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>24</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>25</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>26</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>27</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>28</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>29</span><br data-v-4f1e9d0c></div></div></div> <div class="theme-code-block" data-v-4f1e9d0c><div class="language-nginx line-numbers-mode" data-v-4f1e9d0c><pre class="language-nginx" data-v-4f1e9d0c><code data-v-4f1e9d0c>! <span class="token directive" data-v-4f1e9d0c><span class="token keyword" data-v-4f1e9d0c>Configuration</span> File for keepalived

global_defs</span> <span class="token punctuation" data-v-4f1e9d0c>{</span>
   <span class="token directive" data-v-4f1e9d0c><span class="token keyword" data-v-4f1e9d0c>notification_email</span></span> <span class="token punctuation" data-v-4f1e9d0c>{</span>
        tom@itcast.cn
        jerry@itcast.cn
   <span class="token punctuation" data-v-4f1e9d0c>}</span>
   notification_email_from zhaomin@itcast.cn
   smtp_server 192.168.200.1
   smtp_connect_timeout 30
   router_id keepalived2
   vrrp_skip_check_adv_addr
   vrrp_strict
   vrrp_garp_interval 0
   vrrp_gna_interval 0
<span class="token punctuation" data-v-4f1e9d0c>}</span>

<span class="token directive" data-v-4f1e9d0c><span class="token keyword" data-v-4f1e9d0c>vrrp_instance</span> VI_1</span> <span class="token punctuation" data-v-4f1e9d0c>{</span>
    <span class="token directive" data-v-4f1e9d0c><span class="token keyword" data-v-4f1e9d0c>state</span> BACKUP
    interface ens33
    virtual_router_id <span class="token number" data-v-4f1e9d0c>51</span>
    priority <span class="token number" data-v-4f1e9d0c>90</span>
    advert_int <span class="token number" data-v-4f1e9d0c>1</span>
    authentication</span> <span class="token punctuation" data-v-4f1e9d0c>{</span>
        auth_type PASS
        auth_pass 1111
    <span class="token punctuation" data-v-4f1e9d0c>}</span>
    <span class="token directive" data-v-4f1e9d0c><span class="token keyword" data-v-4f1e9d0c>virtual_ipaddress</span></span> <span class="token punctuation" data-v-4f1e9d0c>{</span>
        192.168.200.222
    <span class="token punctuation" data-v-4f1e9d0c>}</span>
<span class="token punctuation" data-v-4f1e9d0c>}</span>
</code></pre> <div class="line-numbers-wrapper" data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>1</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>2</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>3</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>4</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>5</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>6</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>7</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>8</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>9</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>10</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>11</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>12</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>13</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>14</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>15</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>16</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>17</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>18</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>19</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>20</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>21</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>22</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>23</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>24</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>25</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>26</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>27</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>28</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>29</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>30</span><br data-v-4f1e9d0c><span class="line-number" data-v-4f1e9d0c>31</span><br data-v-4f1e9d0c></div></div></div> <pre class="pre-blank" data-v-2f5f1757>// Make sure to add code blocks to your code group</pre></div> <h3 id="访问测试"><a href="#访问测试" class="header-anchor">#</a> 访问测试</h3> <ol><li>启动 keepalived 之前，先使用命令 <code>ip a</code>，查看 <code>192.168.200.133</code> 和 <code>192.168.200.122</code> 这两台服务器的 IP 情况</li></ol> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Nginx/20211129162240.png" alt="1604599529242"></p> <ol start="2"><li>分别启动两台服务器的 keepalived</li></ol> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /usr/local/sbin

./keepalived
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>再次通过 <code>ip a</code> 查看 IP</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Nginx/20211129162308.png" alt="1604599616821"></p> <p>此时发现服务器 A 多出了 <code>192.168.200.222</code>，正是配置的虚拟路由 VIP，而服务器 B 并没有，说明服务器 A 是 Master，优先级高于服务器 B。</p> <ol start="3"><li>当把 <code>192.168.200.133</code> 服务器 A 上的 keepalived 关闭后，再次查看 IP</li></ol> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Nginx/20211129162648.png" alt="1604599709822"></p> <p>说明当 Master 服务器 A 宕机后，服务器 B 由 Backup 晋升为 Master。</p> <p>通过上述的测试，我们会发现，虚拟 IP(VIP)会在 Master 节点上，当 Master 节点上的 keepalived 出问题以后，因为 Backup 无法收到 Master 发出的 VRRP 状态通过信息，就会直接升为 Master 。VIP 也会「漂移」到新的 Master 。</p> <p><strong>上面测试和 Nginx 有什么关系?</strong></p> <p>我们把 <code>192.168.200.133</code> 服务器 A 的 keepalived 再次启动下，由于它的优先级高于 <code>192.168.200.122</code> 服务器 B，所有它会再次成为 Master，VIP 也会「漂移」过去。</p> <p>我们通过浏览器访问：</p> <div class="language-http line-numbers-mode"><pre class="language-http"><code><span class="token header"><span class="token header-name keyword">http</span><span class="token punctuation">:</span><span class="token header-value">//192.168.200.222/</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Nginx/20211129163014.png" alt="1604600079149"></p> <p>如果把 <code>192.168.200.133</code> 服务器 A 的 keepalived 进程关闭掉</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function">kill</span> keepalived 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>再次访问相同的地址，效果如图：</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Nginx/20211129163225.png" alt="1604600145318"></p> <p>虽然效果成功实现了，但是此时是我们手动把服务器上的 keepalived 关闭，才让 VIP 进行切换。</p> <p><strong>而什么时候关闭 keepalived 呢？</strong></p> <p>应该是在 keepalived 所在服务器的 Nginx 出现问题后，把 keepalived 关闭掉，就可以让 VIP 执行另外一台服务器。<strong>但是现在这所有的操作都是通过手动来完成的</strong>，我们如何能让系统自动判断当前服务器的 Nginx 是否正确启动，如果没有，要能让 VIP 自动进行「漂移」，这个问题该如何解决？往下看。</p> <h3 id="vrrp-script"><a href="#vrrp-script" class="header-anchor">#</a> vrrp_script</h3> <p>keepalived 只能做到对网络故障和 keepalived 本身的监控，即当出现网络故障或者 keepalived 本身出现问题时，进行切换。但是这些还不够，我们还需要监控 keepalived 所在服务器上的其他业务，比如 Nginx，如果 Nginx 出现异常了，而 keepalived 却保持正常，是无法完成系统的正常工作的，因此需要根据业务进程的运行状态决定是否需要进行主备切换，这个时候，我们可以通过编写脚本对业务进程进行检测监控。</p> <p>首先我们要知道 keepalived 的 vrrp_script 的配置模板：</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">vrrp_script</span> 脚本名称</span>
<span class="token punctuation">{</span>
    script &quot;脚本位置&quot;
    interval 3 <span class="token comment"># 执行时间间隔</span>
    weight -20 <span class="token comment"># 动态调整 vrrp_instance 的优先级</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>实现步骤：</p> <ul><li><p>编写脚本，这里的脚本名是 <code>ck_nginx.sh</code>，位置在 <code>/etc/keepalived</code> 路径下</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token shebang important">#!/bin/bash</span>
<span class="token assign-left variable">num</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">ps</span> -C nginx --no-header <span class="token operator">|</span> <span class="token function">wc</span> -l<span class="token variable">`</span></span>  <span class="token comment"># 查询 Nginx 的进程数</span>

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$num</span> -eq <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>       	       <span class="token comment"># 如果 Nginx 的进程数等于 0</span>
/usr/local/nginx/sbin/nginx			   <span class="token comment"># 则可执行文件 nginx，启动 Nginx 服务</span>

<span class="token function">sleep</span> <span class="token number">2</span>								   <span class="token comment"># 阻塞 2 秒 </span>

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable"><span class="token variable">`</span><span class="token function">ps</span> -C nginx --no-header <span class="token operator">|</span> <span class="token function">wc</span> -l<span class="token variable">`</span></span> -eq <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>  <span class="token comment"># 再次查询 Nginx 的进程数</span>
<span class="token function">killall</span> keepalived		<span class="token comment"># 如果 Nginx 的进程数不等于 0，则杀死 keepalived 进程</span>

<span class="token keyword">fi</span>
<span class="token keyword">fi</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ul><li><p>ps 命令用于显示当前进程 (process) 的状态。</p></li> <li><p>-C(command)：指定命令的所有进程</p></li> <li><p>--no-header：排除标题</p></li></ul> <p>命令的效果如图：</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Nginx/20211129164825.png" alt="image-20211129164825064"></p> <p>代表目前的 num = 3。</p> <p>这个脚本其实就是判断 Nginx 是否启动还是宕机了，如果没有启动，则重新启动。重新启动后再次查看 Nginx 是否启动成功，如果没有启动，说明 Nginx 宕机了，则杀死 keepalived 进程，这样，另一台服务器的 Nginx 就晋升为 Master。</p></li> <li><p>为脚本文件设置权限</p></li></ul> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function">chmod</span> <span class="token number">755</span> ck_nginx.sh
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li><p>将脚本添加到 Master 服务器 A 的 keepalived 的配置文件里</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function">vim</span> /etc/keepalived/keepalived.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>添加如下内容：</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">vrrp_script</span> ck_nginx</span> <span class="token punctuation">{</span>
   script &quot;/etc/keepalived/ck_nginx.sh&quot; <span class="token comment"># 执行脚本的位置</span>
   interval 2		<span class="token comment"># 执行脚本的周期，秒为单位</span>
   weight -20		<span class="token comment"># 权重的计算方式</span>
<span class="token punctuation">}</span>
<span class="token directive"><span class="token keyword">vrrp_instance</span> VI_1</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">state</span> MASTER
    interface ens33
    virtual_router_id <span class="token number">10</span>
    priority <span class="token number">100</span>
    advert_int <span class="token number">1</span>
    authentication</span> <span class="token punctuation">{</span>
        auth_type PASS
        auth_pass 1111
    <span class="token punctuation">}</span>
    <span class="token directive"><span class="token keyword">virtual_ipaddress</span></span> <span class="token punctuation">{</span>
        192.168.200.111
    <span class="token punctuation">}</span>
    <span class="token directive"><span class="token keyword">track_script</span></span> <span class="token punctuation">{</span>
      ck_nginx
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div></li> <li><p>如果效果没有出来，可以使用 <code>tail -f /var/log/messages</code> 查看日志信息，找对应的错误信息</p></li> <li><p>两个 Nginx 启动后，关闭 Master 的 Nginx，通过 <code>ip a</code> 查看 Backup 的 Nginx 的IP，是否晋升为 Master</p></li></ul> <p><strong>问题思考</strong></p> <p>通常如果 Master 服务死掉后，Backup 会变成 Master，但是当原来的 Master 服务又恢复了，它会和原来的 Backup 会抢占 VIP，这样就会发生两次切换，这对业务繁忙的网站来说是不好的。所以我们要在配置文件加入 nopreempt 非抢占，但是这个参数只能用于 Backup 的服务器，所以我们在用配置的时候，最好 Master 和 Backup 的 state 都设置成 Backup，这样它们只能通过 priority 优先级来竞争。</p></div></div> <!----> <div class="page-edit"><div class="edit-link"><a href="https://github.com/Small-market/Small-market.github.io/edit/master/docs/30.框架/50.高性能服务器 - Nginx/21.Nginx - 部署与集群.md" target="_blank" rel="noopener noreferrer">编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="tags"><a href="/tags/?tag=Nginx" title="标签">#Nginx</a></div> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">2022/07/25, 10:43:51</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/nginx/cache-integration/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">Nginx - 缓存集成</div></a> <a href="/nginx/site-auth/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">Nginx - 站点与认证</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/nginx/cache-integration/" class="prev">Nginx - 缓存集成</a></span> <span class="next"><a href="/nginx/site-auth/">Nginx - 站点与认证</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/design-pattern/thought/"><div>
            设计模式 - 设计思想
            <!----></div></a> <span class="date">07-12</span></dt></dl><dl><dd>02</dd> <dt><a href="/design-pattern/seven-principles/"><div>
            设计模式 - 七大原则认识
            <!----></div></a> <span class="date">07-12</span></dt></dl><dl><dd>03</dd> <dt><a href="/design-pattern/uml-class-diagram/"><div>
            设计模式 - UML类图
            <!----></div></a> <span class="date">07-12</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="https://github.com/Small-market" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://gitee.com/Small-market" title="Gitee" target="_blank" class="iconfont icon-gitee"></a><a href="https://small-market.gitee.io" title="网站首页" target="_blank" class="iconfont icon-rss"></a><a href="http://wpa.qq.com/msgrd?v=3&amp;uin=2495539878&amp;site=qq&amp;menu=yes" title="QQ" target="_blank" class="iconfont icon-QQ"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2022-2022
    <span>Gavin  | blog<br> <a href="https://gitee.com/small-market/small-market/blob/master/LICENSE" target="_blank">开源许可 MIT</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <!----></div><div class="global-ui"><div></div><div></div><div></div><div id="tcomment"></div><!----><!----><APlayer audio="" fixed="true" mini="true" theme="#b7daff" loop="loop" order="list" preload="auto" volume="0.7" mutex="true" lrc-type="0" list-max-height="250" storage-name="vuepress-plugin-meting" id="aplayer-fixed"></APlayer><canvas id="vuepress-canvas-cursor"></canvas><div></div></div></div>
    <script src="/assets/js/app.0c74b603.js" defer></script><script src="/assets/js/2.05f7d542.js" defer></script><script src="/assets/js/213.b44014c3.js" defer></script><script src="/assets/js/15.8dd074d9.js" defer></script><script src="/assets/js/5.a78e8ca1.js" defer></script><script src="/assets/js/16.e2aaf81b.js" defer></script><script src="/assets/js/12.aaee4f64.js" defer></script>
  </body>
</html>
